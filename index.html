<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Encargos Cocina</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e2537;
      --text: #f8fafc;
      --text-dim: #94a3b8;
      --accent: #38bdf8;
      --danger: #ef4444;
      --radius-lg: 18px;
      --radius-sm: 10px;
    }
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);padding:1rem;}
    header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.75rem;}
    h1{font-size:1.2rem;margin:0;display:flex;align-items:center;gap:.5rem;}
    .today{background:rgba(56,189,248,.15);color:var(--accent);padding:.25rem .5rem;border-radius:10px;font-size:.75rem;}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap;}
    button{border:0;border-radius:10px;padding:.6rem .8rem;font-weight:600;cursor:pointer;}
    .primary{background:var(--accent);color:#0a0f1a;}
    .danger{background:rgba(239,68,68,.1);color:var(--danger);}
    main{display:grid;gap:1rem;margin-top:1rem;}
    @media(min-width:768px){main{grid-template-columns:320px 1fr;}}
    .card{background:var(--panel);border-radius:18px;padding:1rem;box-shadow:0 20px 40px rgba(0,0,0,.5);}
    .card h2{margin:0 0 .75rem 0;font-size:1rem;}
    form{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;}
    .full{grid-column:span 2;}
    label{display:block;font-size:.8rem;color:var(--text-dim);margin-bottom:.3rem;}
    input,textarea{width:100%;background:#0f172a;color:var(--text);border:1px solid #475569;border-radius:10px;padding:.6rem;font-size:.9rem;}
    textarea{min-height:60px;resize:none;}
    .submit{grid-column:span 2;background:var(--accent);color:#0a0f1a;}
    .encargo{background:#0f172a;border:1px solid #334155;border-radius:12px;padding:.75rem;margin-bottom:.75rem;}
    .line1{display:flex;justify-content:space-between;flex-wrap:wrap;gap:.5rem;font-weight:600;}
    .hora{background:rgba(56,189,248,.15);color:var(--accent);padding:.2rem .5rem;border-radius:8px;font-size:.75rem;}
    .meta{color:var(--text-dim);font-size:.85rem;line-height:1.4;margin-top:.4rem;white-space:pre-line;}
    .delete{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(239,68,68,.4);padding:.35rem .6rem;border-radius:8px;font-size:.75rem;}
  </style>
</head>
<body>
  <header>
    <h1>Encargos cocina <span class="today" id="today"></span></h1>
    <div class="actions">
      <button class="primary" id="btnNuevo" type="button">‚ûï Nuevo encargo</button>
      <button class="danger"  id="btnVaciar" type="button">üóë Vaciar d√≠a</button>
    </div>
    <div class="actions">
      <button id="btnHoy"  type="button">üìÖ Hoy</button>
      <button id="btnTodo" type="button">üìã Todo</button>
      <span id="badgeCount" class="today"></span>
    </div>
  </header>

  <main>
    <section class="card" id="formCard">
      <h2>Nuevo encargo</h2>
      <form id="formEncargo">
        <div class="full">
          <label>Detalle</label>
          <textarea id="descripcion" placeholder="Tortillas, Fritos, Bocatines" required></textarea>
        </div>
        <div><label>D√≠a</label><input id="fecha" type="date" required /></div>
        <div><label>Hora</label><input id="hora" type="time" required /></div>
        <div><label>Cliente</label><input id="nombre" type="text" required /></div>
        <div><label>Tel√©fono</label><input id="telefono" type="tel" required /></div>
        <div><label>Anotado por</label><input id="persona" type="text" placeholder="Nombre Trabajador" /></div>
        <div><label>Notas</label><input id="notas" type="text" placeholder="Para Llevar, Alergias" /></div>
        <button class="submit" type="submit">Guardar</button>
      </form>
    </section>

    <section class="card">
      <h2>Encargos</h2>
      <div id="lista"></div>
    </section>
  </main>

  <!-- Modal Editar -->
  <div id="editModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:50;align-items:center;justify-content:center;">
    <div style="background:#1e2537;border:1px solid #334155;border-radius:14px;padding:14px;max-width:520px;width:92%;">
      <h3 style="margin:0 0 .5rem 0">Editar encargo</h3>
      <form id="editForm" style="display:grid;grid-template-columns:1fr 1fr;gap:.6rem;">
        <div style="grid-column:1/3">
          <label style="font-size:.8rem;color:#94a3b8">Detalle</label>
          <textarea id="e-descripcion" required></textarea>
        </div>
        <div><label style="font-size:.8rem;color:#94a3b8">D√≠a</label><input id="e-fecha" type="date" required></div>
        <div><label style="font-size:.8rem;color:#94a3b8">Hora</label><input id="e-hora" type="time" required></div>
        <div><label style="font-size:.8rem;color:#94a3b8">Cliente</label><input id="e-nombre" type="text" required></div>
        <div><label style="font-size:.8rem;color:#94a3b8">Tel√©fono</label><input id="e-telefono" type="tel" required></div>
        <div><label style="font-size:.8rem;color:#94a3b8">Anotado por</label><input id="e-persona" type="text"></div>
        <div><label style="font-size:.8rem;color:#94a3b8">Notas</label><input id="e-notas" type="text"></div>
        <div style="grid-column:1/3;display:flex;gap:.5rem;justify-content:flex-end;margin-top:.3rem">
          <button type="button" id="btnCancelEdit">Cancelar</button>
          <button type="submit" class="primary">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== App moderna (modules) ===== -->
  <script type="module">
    /* TU firebaseConfig */
    const firebaseConfig = {
      apiKey: "AIzaSyCwWNzBYuB59EYZAdO7EuTysIaFiRwRgVs",
      authDomain: "encargos-cocina.firebaseapp.com",
      projectId: "encargos-cocina",
      storageBucket: "encargos-cocina.firebasestorage.app",
      messagingSenderId: "147677552505",
      appId: "1:147677552505:web:ab956b3fb56eccd46419a8",
      measurementId: "G-2QGJNLDQGK"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, doc, deleteDoc, updateDoc,
      onSnapshot, query, orderBy, enableIndexedDbPersistence, serverTimestamp, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // Inicializaci√≥n
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    await signInAnonymously(auth);
    enableIndexedDbPersistence(db).catch(()=>{});

    // UI: fecha cabecera
    document.getElementById("today").textContent =
      new Date().toLocaleDateString("es-ES",{weekday:"short", day:"2-digit", month:"short"});

    const hoyStr = () => {
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    };

    // Colecci√≥n y refs
    const col   = collection(db, "encargos");
    const lista = document.getElementById("lista");
    const badgeCount = document.getElementById("badgeCount");

    // Estado
    let lastDocs = [];
    let stop;

    // Render
    function render(snap){
      lastDocs = snap.docs;
      badgeCount.textContent = `‚Ä¢ ${snap.size} encargos`;

      if (snap.empty){
        lista.innerHTML = "<p style='color:#94a3b8'>No hay encargos</p>";
        return;
      }

      lista.innerHTML = snap.docs.map(d=>{
        const e = d.data();
        return `
          <div class="encargo">
            <div class="line1">
              <div>${e.descripcion || ""}</div>
              <div class="hora">${e.hora || ""}</div>
            </div>
            <div class="meta">
              üë§ ${e.nombreCliente || ""} ‚Äî üìû ${e.telefonoCliente || ""}\n
              üìÖ ${e.fecha || ""} ${e.notas ? `\nüìù ${e.notas}` : ""} ${e.persona ? `\nüßæ ${e.persona}` : ""}
            </div>
            <div style="margin-top:.5rem;display:flex;gap:.5rem">
              <button class="delete" data-action="delete" data-id="${d.id}">Borrar</button>
              <button class="edit"   data-action="edit"   data-id="${d.id}">Editar</button>
            </div>
          </div>
        `;
      }).join("");
    }

    // Delegaci√≥n de eventos (borrar/editar)
    lista.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("button[data-action]");
      if(!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if(action === "delete"){
        deleteDoc(doc(db,"encargos", id));
      } else if(action === "edit"){
        const enc = lastDocs.find(x=>x.id===id);
        if (enc) openEdit(enc);
      }
    });

    // Suscripciones
    function subscribeAll(){
      if (stop) stop();
      const q = query(col, orderBy("fechaHora"));
      stop = onSnapshot(q, render);
    }
    function subscribeToday(){
      if (stop) stop();
      const start = `${hoyStr()}T00:00`;
      const end   = `${hoyStr()}T23:59`;
      const q = query(
        col, orderBy("fechaHora"),
        where("fechaHora", ">=", start),
        where("fechaHora", "<=", end)
      );
      stop = onSnapshot(q, render);
    }

    document.getElementById("btnHoy").onclick  = subscribeToday;
    document.getElementById("btnTodo").onclick = subscribeAll;

    // Guardar
    document.getElementById("formEncargo").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const f = e.target;
      const fechaHora = `${f.fecha.value}T${f.hora.value}`;
      await addDoc(col, {
        descripcion:     f.descripcion.value.trim(),
        fecha:           f.fecha.value,
        hora:            f.hora.value,
        fechaHora,
        nombreCliente:   f.nombre.value.trim(),
        telefonoCliente: f.telefono.value.trim(),
        persona:         f.persona.value.trim(),
        notas:           f.notas.value.trim(),
        creado:          serverTimestamp()
      });
      f.reset();
    });

    // Vaciar d√≠a (borra los visibles)
    document.getElementById("btnVaciar").onclick = async ()=>{
      if (!confirm("¬øBorrar TODOS los encargos visibles?")) return;
      for (const d of lastDocs){ await deleteDoc(doc(db,"encargos", d.id)); }
    };

    // Modal edici√≥n
    const editModal = document.getElementById("editModal");
    const editForm  = document.getElementById("editForm");
    let editingId = null;

    const openEdit = (enc)=>{
      editingId = enc.id;
      const e = enc.data();
      document.getElementById("e-descripcion").value = e.descripcion || "";
      document.getElementById("e-fecha").value       = e.fecha || "";
      document.getElementById("e-hora").value        = e.hora || "";
      document.getElementById("e-nombre").value      = e.nombreCliente || "";
      document.getElementById("e-telefono").value    = e.telefonoCliente || "";
      document.getElementById("e-persona").value     = e.persona || "";
      document.getElementById("e-notas").value       = e.notas || "";
      editModal.style.display = "flex";
    };
    const closeEdit = ()=>{ editingId=null; editModal.style.display="none"; };
    document.getElementById("btnCancelEdit").onclick = closeEdit;

    editForm.onsubmit = async (ev)=>{
      ev.preventDefault();
      if(!editingId) return;
      const fecha = document.getElementById("e-fecha").value;
      const hora  = document.getElementById("e-hora").value;
      const fechaHora = `${fecha}T${hora}`;
      await updateDoc(doc(db,"encargos", editingId),{
        descripcion:     document.getElementById("e-descripcion").value.trim(),
        fecha, hora, fechaHora,
        nombreCliente:   document.getElementById("e-nombre").value.trim(),
        telefonoCliente: document.getElementById("e-telefono").value.trim(),
        persona:         document.getElementById("e-persona").value.trim(),
        notas:           document.getElementById("e-notas").value.trim()
      });
      closeEdit();
    };

    // ARRANQUE: TODO (m√°s robusto si la fecha del dispositivo no coincide)
    subscribeAll();

  </script>

  <!-- ===== Fallback para navegadores antiguos (sin modules) ===== -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js" nomodule></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js" nomodule></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js" nomodule></script>
  <script nomodule>
    const firebaseConfig = {
      apiKey: "AIzaSyCwWNzBYuB59EYZAdO7EuTysIaFiRwRgVs",
      authDomain: "encargos-cocina.firebaseapp.com",
      projectId: "encargos-cocina",
      storageBucket: "encargos-cocina.firebasestorage.app",
      messagingSenderId: "147677552505",
      appId: "1:147677552505:web:ab956b3fb56eccd46419a8",
      measurementId: "G-2QGJNLDQGK"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    auth.signInAnonymously().catch(()=>{});
    const db = firebase.firestore();
    db.enablePersistence().catch(()=>{});

    const lista = document.getElementById("lista");
    const badge = document.getElementById("badgeCount");
    const col   = db.collection("encargos");

    const hoyStr = () => {
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    };

    function renderSnap(snap){
      badge.textContent = `‚Ä¢ ${snap.size} encargos`;
      if (snap.empty){ lista.innerHTML = "<p style='color:#94a3b8'>No hay encargos</p>"; return; }
      lista.innerHTML = snap.docs.map(d=>{
        const e = d.data();
        return `
          <div class="encargo">
            <div class="line1">
              <div>${e.descripcion||""}</div>
              <div class="hora">${e.hora||""}</div>
            </div>
            <div class="meta">
              üë§ ${e.nombreCliente||""} ‚Äî üìû ${e.telefonoCliente||""}<br>
              üìÖ ${e.fecha||""} ${e.notas?`üìù ${e.notas}`:""} ${e.persona?`üßæ ${e.persona}`:""}
            </div>
            <div style="margin-top:.5rem;display:flex;gap:.5rem">
              <button class="delete" data-id="${d.id}">Borrar</button>
            </div>
          </div>`;
      }).join("");
    }

    let unsub;
    function subscribeAll(){ if (unsub) unsub(); unsub = col.orderBy("fechaHora").onSnapshot(renderSnap); }
    function subscribeToday(){
      if (unsub) unsub();
      const start = `${hoyStr()}T00:00`;
      const end   = `${hoyStr()}T23:59`;
      unsub = col.where("fechaHora", ">=", start).where("fechaHora", "<=", end).orderBy("fechaHora").onSnapshot(renderSnap);
    }

    document.getElementById("btnHoy").onclick  = subscribeToday;
    document.getElementById("btnTodo").onclick = subscribeAll;

    document.getElementById("formEncargo").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const f = e.target;
      const fechaHora = `${f.fecha.value}T${f.hora.value}`;
      await col.add({
        descripcion: f.descripcion.value.trim(),
        fecha: f.fecha.value,
        hora: f.hora.value,
        fechaHora,
        nombreCliente: f.nombre.value.trim(),
        telefonoCliente: f.telefono.value.trim(),
        persona: f.persona.value.trim(),
        notas: f.notas.value.trim(),
        creado: firebase.firestore.FieldValue.serverTimestamp()
      });
      f.reset();
    });

    document.getElementById("lista").addEventListener("click",(ev)=>{
      const id = ev.target?.dataset?.id;
      if (ev.target.matches(".delete") && id){ col.doc(id).delete(); }
    });

    // Arranque robusto
    subscribeAll();
  </script>
</body>
</html>
